# ç¬¬åäºŒç«  å­æ¨¡å—(Submodule)

[â‡¦ä¸Šä¸€ç« ](11.md) - [é¦–é¡µğŸ ](index.md) - [ä¸‹ä¸€ç« â‡¨](13.md)

---

- [ç¬¬åäºŒç«  å­æ¨¡å—(Submodule)](#ç¬¬åäºŒç« -å­æ¨¡å—submodule)
  - [1. å®éªŒå‡†å¤‡](#1-å®éªŒå‡†å¤‡)
    - [1.1 Remote Server](#11-remote-server)
    - [1.2 Local Host](#12-local-host)
      - [1.2.1 Clone Repo](#121-clone-repo)
      - [1.2.2 Prepare Data](#122-prepare-data)
  - [2. æ·»åŠ å­æ¨¡å—](#2-æ·»åŠ å­æ¨¡å—)
  - [3. Clone å¸¦æœ‰å­æ¨¡å—çš„ä»“åº“](#3-clone-å¸¦æœ‰å­æ¨¡å—çš„ä»“åº“)
  - [4. æ›´æ–°å­æ¨¡å—](#4-æ›´æ–°å­æ¨¡å—)
  - [5. åˆ é™¤å­æ¨¡å—](#5-åˆ é™¤å­æ¨¡å—)
  - [6. ã€Œåˆ é™¤åå†åŠ ã€é—®é¢˜å¤„ç†](#6-åˆ é™¤åå†åŠ é—®é¢˜å¤„ç†)

---

æŒ‰ï¼šå­æ¨¡å—å¹¶ä¸æ˜¯å¿…é¡»çš„ï¼Œå¦‚æœé¡¹ç›®æ¯”è¾ƒç®€å•ï¼Œå®Œå…¨æ²¡å¿…è¦ä½¿ç”¨å­æ¨¡å—ã€‚æœ¬ç« å†…å®¹å¯ä»¥åœ¨éœ€è¦æ—¶å†çœ‹ã€‚

ä¸€èˆ¬ä¸€ä¸ªä»“åº“ç”¨äºä¸€ä¸ªé¡¹ç›®ï¼Œé¡¹ç›®ä¹‹é—´å¾€å¾€æœ‰ä¸€äº›ä»£ç ä¾èµ–å…³ç³»ï¼Œæ­¤æ—¶æˆ‘ä»¬ç”¨å­æ¨¡å—çš„æ–¹å¼æ¥å»ºç«‹è¿™ç§ä¾èµ–å…³ç³»â€”â€”ç±»ä¼¼ Java é¡¹ç›®ä¸­çš„ maven ä¾èµ–ã€‚

å­æ¨¡å—æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ä»“åº“ï¼Œå®ƒçš„ç‰ˆæœ¬ç®¡ç†ç”±å®ƒè‡ªå·±ã€‚ä¸€ä¸ªä»“åº“ A å°†å¦å¤–ä¸€ä¸ªä»“åº“ B ç”¨ä½œå­æ¨¡å—ï¼Œåˆ™ A æŒæœ‰ B çš„ repo URL ä»¥åŠç”¨ä½œå­æ¨¡å—çš„ B çš„ç‰ˆæœ¬å·(commit ID)ã€‚

## 1. å®éªŒå‡†å¤‡

### 1.1 Remote Server

IP: 192.168.0.102

Create two git repositories:

```plaintext
$ pwd
/home/caoyi/sandbox/test
$ git init --bare project-main.git
$ git init --bare project-sub.git
```

### 1.2 Local Host

è¿œç«¯çš„ä»“åº“åˆ›å»ºå¥½åï¼Œå†å°†å®ƒä»¬ clone åˆ°æœ¬åœ°ã€‚

#### 1.2.1 Clone Repo

```plaintext
$ pwd
/d/sandbox/temp
$ git clone ssh://caoyi@192.168.0.102/home/caoyi/sandbox/test/project-main.git
$ git clone ssh://caoyi@192.168.0.102/home/caoyi/sandbox/test/project-sub.git
```

#### 1.2.2 Prepare Data

main repo

```plaintext
$ pwd
/d/sandbox/temp/project-main
$ echo "hello from main repo" > hello.txt
$ git add .
$ git commit -m "first commit in main repo"
$ git push origin main
```

sub repo:

```plaintext
$ pwd
/d/sandbox/temp/project-sub
$ echo "hello from the sub repo" > hello-sub.txt
$ git add .
$ git commit -m "first commit in the sub repo"
$ git push origin main
```

## 2. æ·»åŠ å­æ¨¡å—

```plaintext
$ pwd
/d/sandbox/temp/project-main
$ git submodule add ssh://caoyi@192.168.0.102/home/caoyi/sandbox/test/project-sub.git
```

ï¼ˆæœ¬ä¾‹åªæ·»åŠ äº†ä¸€ä¸ªå­æ¨¡å—ï¼Œå®é™…å¼€å‘ä¸­ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ è‹¥å¹²ã€‚æ·»åŠ çš„æ¨¡å—é»˜è®¤ä»¥ä»“åº“çš„ååˆ›å»ºä¸€ä¸ªæ–°çš„ç›®å½•ï¼Œå¦‚æœè¦ä½¿ç”¨å…¶ä»–åç§°ï¼Œå¯ä»¥å°†è‡ªå®šä¹‰åç§°è·Ÿåœ¨ä¸Šé¢çš„æŒ‡ä»¤æœ€åã€‚ï¼‰

é€šè¿‡ `git status` å‘ç°å¤šäº†ä¸¤ä¸ªæ–‡ä»¶

```plaintext
$ git status
On branch main
Your branch is up to date with 'origin/main'.

Changes to be committed:
  (use "git restore --staged <file>..." to unstage)
        new file:   .gitmodules
        new file:   project-sub
```

.gitmodules é‡Œè®°å½•äº†å­—æ¨¡å—çš„ä¿¡æ¯

```plaintext
$ cat .gitmodules
[submodule "project-sub"]
        path = project-sub
        url = ssh://caoyi@192.168.0.102/home/caoyi/sandbox/test/project-sub.git
```

project-sub å°±æ˜¯å¼•å…¥äº†å­æ¨¡å—çš„ç›®å½•ï¼Œä¸»åº“åªä¼šæŠŠè¿™ä¸ªç›®å½•åå½“ä½œä¸€ä¸ªæ–‡ä»¶åŠ å…¥ç‰ˆæœ¬ç®¡ç†çš„ä¿¡æ¯ä¸­ï¼Œè€Œä¸ä¼šå»ç®¡ç†ç›®å½•å†…éƒ¨çš„å†…å®¹ï¼Œé‚£æ˜¯å­æ¨¡å—è‡ªå·±å»ç®¡ç†çš„ï¼Œå› æ­¤ï¼Œå³ä½¿ä½¿ç”¨ `git add` ä¹Ÿä¸ä¼šæŠŠå­æ¨¡å—ç›®å½•é‡Œçš„å†…å®¹æ·»åŠ åˆ°ä¸»åº“çš„ Staging Area ä¸­ï¼Œè¿™æ ·çš„è®¾è®¡å¾ˆåˆç†ï¼Œå¦åˆ™å°±ä¸éœ€è¦ submodule äº†ã€‚

å­æ¨¡å—å…¥åº“ï¼š

```plaintext
$ git commit -m "add submodule"
[main 99d7ec7] add submodule
 2 files changed, 4 insertions(+)
 create mode 100644 .gitmodules
 create mode 160000 project-sub
$ git push origin main
```

æŸ¥çœ‹å­æ¨¡å—çš„çŠ¶æ€

```plaintext
$ git submodule status
-bf676211dc70759919951a9b8974e57b816d3568 project-sub
```

## 3. Clone å¸¦æœ‰å­æ¨¡å—çš„ä»“åº“

å¦‚æœç›´æ¥ cloneï¼Œä¸å¸¦å‚æ•°ï¼Œå¾—åˆ°çš„ä»“åº“ï¼Œæ˜¯ä¸ä¼šæœ‰å­æ¨¡å—çš„ï¼Œéœ€è¦ç»§ç»­æ‰§è¡Œ `submodule init + update` æ‰è¡Œï¼Œå³ï¼š

```plaintext
$ git clone ssh://caoyi@192.168.0.102/home/caoyi/sandbox/test/project-main.git
$ git submodule init
$ git submodule update
```

`init` å’Œ `update` ä¸¤å¥è¿˜å¯ä»¥åˆå†™ä¸º `git submodule update --init`, å¦‚æœè€ƒè™‘æ¨¡å—åµŒå¥—ï¼Œè¿˜å¯ä»¥å†™ä½œ `git submodule update --init --recursive`.

ä¹Ÿå¯ä»¥ä½¿ç”¨ `--recurse-submodules` ä¸€æ­¥åˆ°ä½ï¼š

```plaintext
$ git clone --recurse-submodules ssh://caoyi@192.168.0.102/home/caoyi/sandbox/test/project-main.git

```

## 4. æ›´æ–°å­æ¨¡å—

å­æ¨¡å—æ˜¯ç‹¬ç«‹çš„ä»“åº“ï¼Œä¸»åº“ä¸èƒ½ç®¡ç†å®ƒçš„ç‰ˆæœ¬ï¼Œå®ƒä¹Ÿä¸çŸ¥å®ƒæ˜¯å“ªäº›åº“çš„å­æ¨¡å—ã€‚

å½“æˆ‘ä»¬é€šè¿‡ä¸»åº“è¿›å…¥åˆ°å­æ¨¡å—ä¸­å¹¶åšäº†ä¿®æ”¹æ—¶ï¼Œè¿™äº›ä¿®æ”¹åªèƒ½é€šè¿‡å­æ¨¡å—çš„åº“åŒºå»å¤„ç†ï¼Œç„¶åä¸»åº“æ›´æ–°å¼•ç”¨ã€‚

æˆ‘ä»¬ç°åœ¨ä¿®æ”¹å­æ¨¡å—çš„ä¸€ç‚¹å†…å®¹ï¼š

```plaintext
$ pwd
/d/sandbox/temp/project-main/project-sub
$ echo "hello from sub in main" >> hello-sub.txt
$ git status
On branch main
Your branch is up to date with 'origin/main'.

Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
        modified:   hello-sub.txt
```

ç„¶åé€€åˆ°ä¸»åº“ç”¨ `git status` æŸ¥çœ‹çŠ¶æ€

```plaintext
$ pwd
/d/sandbox/temp/project-main
$ git status
On branch main
Your branch is up to date with 'origin/main'.

Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
  (commit or discard the untracked or modified content in submodules)
        modified:   project-sub (modified content)

no changes added to commit (use "git add" and/or "git commit -a")
```

å±å¹•æç¤ºï¼šä¸»åº“æ— ä»»ä½•å˜åŒ–ï¼Œä½†å­æ¨¡å—æœ‰å˜åŒ–ï¼Œä¸è¿‡éœ€è¦è¿›å…¥å­æ¨¡å—å»å¤„ç†ã€‚OKï¼Œæˆ‘ä»¬ç°åœ¨å»å­æ¨¡å—é‡Œå¤„ç†ä¸€ä¸‹ï¼š

```plaintext
$ pwd
/d/sandbox/temp/project-main/project-sub
$ git add .
$ git commit -m "hello from sub module in main/sub"
$ git push origin main
```

é€€åˆ°ä¸»åº“ç”¨ `git status` æŸ¥çœ‹çŠ¶æ€ï¼š

```plaintext
$ pwd
/d/sandbox/temp/project-main
$ git status
On branch main
Your branch is up to date with 'origin/main'.

Changes not staged for commit:
  (use "git add <file>..." to update what will be committed)
  (use "git restore <file>..." to discard changes in working directory)
        modified:   project-sub (new commits)

no changes added to commit (use "git add" and/or "git commit -a")
```

å±å¹•æç¤ºï¼šä¸»åº“æ— ä»»ä½•å˜åŒ–ï¼Œä½†å­æ¨¡å—æœ‰æ–°çš„ commit. å‡è‹¥æˆ‘ä»¬çš„ä¸»æ¨¡å—éœ€è¦ä½¿ç”¨è¿™ä¸ªæ›´æ–°åçš„å­æ¨¡å—ï¼Œæˆ‘ä»¬æŒ‰å¦‚ä¸‹æ“ä½œï¼š

```plaintext
$ pwd
/d/sandbox/temp/project-main
$ git add .
$ git commit -m "update submodule"
$ git push origin main
```

å¯ç”¨ `git show` çœ‹çœ‹åˆšæ‰çš„åˆ°åº•ä¿®æ”¹äº†ä»€ä¹ˆ

```plaintext
$ git show
commit 93e78e5971682ec1765cde2a24732ab565538892 (HEAD -> main, origin/main)
Author: Cao Yi <iridiumcao@gmail.com>
Date:   Thu Dec 21 21:03:23 2023 +0800

    update submodule

diff --git a/project-sub b/project-sub
index bf67621..950e20e 160000
--- a/project-sub
+++ b/project-sub
@@ -1 +1 @@
-Subproject commit bf676211dc70759919951a9b8974e57b816d3568
+Subproject commit 950e20e33528800ca4aa1255446c6f51b1019f97
```

å¯è§ä¸»åº“é‡Œé‚£ä¸ªå’Œ submodule æ–‡ä»¶å¤¹åŒåçš„æ–‡ä»¶é‡Œè®°å½•çš„æ˜¯å­æ¨¡å—çš„æŸä¸ª commit IDï¼Œå³å½“å‰ä¸»åº“ä½¿ç”¨çš„å­æ¨¡å—çš„ç‰ˆæœ¬å·ã€‚è¿™ä¸ªæ–‡ä»¶ç”¨æˆ·æ˜¯ä¸å¯è§çš„ï¼Œç©¶ç«Ÿåœ¨å“ªï¼Ÿ(todo)

å¦‚æœå­æ¨¡å—çš„è¿œç«¯æœ‰æ›´æ–°ï¼Œå¯ä»¥å…ˆåˆ°å­æ¨¡å—ä¸­æ›´æ–°ï¼Œç„¶åä¸»åº“è€ƒè™‘æ˜¯å¦ä½¿ç”¨è¿™ä¸ªæœ€æ–°çš„ç‰ˆæœ¬ã€‚

å¯ä»¥åœ¨ä¸»åº“ä½¿ç”¨ `--recurse-submodules` ä¸€æ­¥åˆ°ä½ï¼ŒæŠŠå­æ¨¡å—ä¹Ÿæ›´æ–°äº†ï¼š

```plaintext
git pull origin  --recurse-submodules
```

è¿™é‡Œæ›´æ–°å­æ¨¡å—ï¼Œä¸ä¸€å®šæ˜¯æŠŠå­æ¨¡å—æ›´æ–°åˆ°å®ƒæœ¬èº«çš„æœ€æ–°ç‰ˆæœ¬ï¼Œè€Œæ˜¯æ›´æ–°åˆ°ä¸»åº“æŒæœ‰çš„ commit ID å¯¹åº”çš„ç‰ˆæœ¬ã€‚

## 5. åˆ é™¤å­æ¨¡å—

åˆ é™¤å­æ¨¡å—éœ€è¦å…ˆä» git repo ä¸­ç§»é™¤ï¼Œç„¶åå†ç‰©ç†åˆ é™¤å­æ¨¡å—çš„ç›®å½•ã€‚

```plaintext
$ pwd
/d/sandbox/temp/project-main
$ git submodule deinit project-sub
$ git rm project-sub
```

æŸ¥çœ‹ä¸€ä¸‹çŠ¶æ€

```plaintext
$ git status
On branch main
Your branch is up to date with 'origin/main'.

Changes to be committed:
  (use "git restore --staged <file>..." to unstage)
        modified:   .gitmodules
        deleted:    project-sub
```

æäº¤å¹¶æ¨é€

```plaintext
$ git commit -m "remove submodule"
$ git push origin main
```

## 6. ã€Œåˆ é™¤åå†åŠ ã€é—®é¢˜å¤„ç†

åˆ é™¤ä¸€ä¸ªå­æ¨¡å—ï¼Œæäº¤ï¼Œå†æ·»åŠ ï¼Œä¼šå‡ºç°ä¸‹é¢çš„æŠ¥é”™ï¼š

```plaintext
$ git submodule add ssh://caoyi@192.168.0.102/home/caoyi/sandbox/test/project-sub.git
fatal: A git directory for 'project-sub' is found locally with remote(s):
  origin        ssh://caoyi@192.168.0.102/home/caoyi/sandbox/test/project-sub.git
If you want to reuse this local git directory instead of cloning again from
  ssh://caoyi@192.168.0.102/home/caoyi/sandbox/test/project-sub.git
use the '--force' option. If the local git directory is not the correct repo
or you are unsure what this means choose another name with the '--name' option.
```

æŒ‰å±å¹•æç¤ºæ”¹æˆè¿™æ ·å°±å¥½äº†ï¼š

```plaintext
$ git submodule add --force ssh://caoyi@192.168.0.102/home/caoyi/sandbox/test/project-sub.git
Reactivating local git directory for submodule 'project-sub'
```

æ³¨æ„ `--force` çš„ä½ç½®ï¼Œä¸èƒ½æ”¾åœ¨æŒ‡ä»¤æœ€åã€‚

---

å‚è€ƒï¼š

* [çŸ¥ä¹Â·Gitä¸­submoduleçš„ä½¿ç”¨Â·å­¤å•å½¼å²¸](https://zhuanlan.zhihu.com/p/87053283)ï¼ˆæœ¬æ–‡çš„å®éªŒè®¾è®¡å‚è€ƒï¼‰
* [Official Document, Help of Submodule](https://git-scm.com/docs/git-submodule)ï¼ˆä¸€äº› `submodule` å‚æ•°è§£é‡Šï¼‰
* [å®˜æ–¹æ–‡æ¡£ï¼ŒGit å·¥å…· - å­æ¨¡å—](https://git-scm.com/book/zh/v2/Git-%E5%B7%A5%E5%85%B7-%E5%AD%90%E6%A8%A1%E5%9D%97)ï¼ˆéƒ¨åˆ†å†…å®¹å‚è€ƒï¼‰
* [Official Document, Git Tools Submodules](https://git-scm.com/book/en/v2/Git-Tools-Submodules)ï¼ˆéƒ¨åˆ†å†…å®¹å‚è€ƒï¼‰

---

[â‡¦ä¸Šä¸€ç« ](11.md) - [é¦–é¡µğŸ ](index.md) - [ä¸‹ä¸€ç« â‡¨](13.md)
